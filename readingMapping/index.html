<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Pinyin to On'yomi Mapping Visualization</title>
	<script src="https://d3js.org/d3.v7.min.js"></script>
	<style>
		/* Add some basic styling */
		.arc {
			stroke: #fff;
		}

		.tooltip {
			position: absolute;
			opacity: 0;
			background-color: white;
			border-radius: 5px;
			padding: 10px;
			box-shadow: 2px 2px 12px rgba(0, 0, 0, 0.2);
		}
	</style>
</head>

<body>
	<!-- Container for the visualization -->
	<div id="visualization"></div>
	<!-- Tooltip for hover details -->
	<div class="tooltip"></div>

	<script type="module">
		// Fetch the data
		fetch('processedMap.json')
			.then(response => response.json())
			.then(data => {
				console.log(data);  // Just to verify the data is being loaded

				const width = 960;
				const height = 480;
				const radius = Math.min(width, height) / 2;

				// const arc = d3.arc()
				// 	.outerRadius(radius - 10)
				// 	.innerRadius(0);
				const arc = d3.arc()
					.outerRadius(radius - 10)
					.innerRadius(radius / 2);  // Setting this to half the outer radius to create a donut

				const color = d3.scaleOrdinal(d3.schemeCategory10);
				const pie = d3.pie()
					.sort(null)
					.value(function (d) { return d.percentage; });

				// For each pinyin, create a pie chart
				Object.entries(data).forEach(([pinyin, readings], index) => {
					const svg = d3.select("body").append("svg")
						.attr("width", width)
						.attr("height", height)
						.append("g")
						.attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

					const g = svg.selectAll(".arc")
						.data(pie(Object.values(readings)))
						.enter().append("g")
						.attr("class", "arc");

					// g.append("path")
					// 	.attr("d", arc)
					// 	.style("fill", function (d, i) { return d3.interpolateRainbow(i / readings.length); });

					// g.append("text")
					// 	.attr("transform", function (d) { return "translate(" + arc.centroid(d) + ")"; })
					// 	.attr("dy", ".35em")
					// 	.text(function (d) { return d.data.readings; });


					// Color the arcs and add hover functionality
					g.append("path")
						.attr("d", arc)
						.style("fill", function (d, i) { return color(i); })
						.on("mouseover", function (event, d) {
							const reading = Object.keys(readings).find(key => readings[key] === d.data);
							d3.select(".tooltip")
								.style("left", (event.pageX + 5) + "px")
								.style("top", (event.pageY - 28) + "px")
								.style("opacity", .9)
								.html(`${reading}<br/>${d.data.kanjis.join(", ")}`);
						})
						.on("mouseout", function (d) {
							d3.select(".tooltip")
								.style("opacity", 0);
						});

					g.append("text")
						.attr("transform", function (d) { return "translate(" + arc.centroid(d) + ")"; })
						.attr("dy", ".35em")
						.text(function (d) {
							return Object.keys(readings).find(key => readings[key] === d.data);
						});

					// Add pinyin to the center of the donut
					svg.append("text")
						.attr("dy", ".35em")
						.style("text-anchor", "middle")
						.text(pinyin);
				});

			})
			.catch(error => {
				console.error('There was an error loading the JSON:', error);
			});

	</script>
</body>

</html>